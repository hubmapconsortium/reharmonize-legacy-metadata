name: Transform IMC-2D legacy metadata

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  transform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyYAML
          pip install openpyxl
          pip install jinja2
          pip install -e tools/json-rules-engine
          pip install -e tools/metadata-transformer

      - name: Generate field mapping
        run: |
          python scripts/generate-field-mapping.py \
            metadata/imc-2d/imc-2d-field-mappings.csv \
            metadata/imc-2d/imc-2d-field-mappings.json

      - name: Generate target schema
        run: |
          python scripts/generate-target-schema.py \
            "https://raw.githubusercontent.com/hubmapconsortium/dataset-metadata-spreadsheet/refs/heads/main/imc-2d/latest/imc-2d.yml" \
            metadata/imc-2d/imc-2d-schema.json

      - name: Transform metadata
        run: |
          metadata-transform \
            --field-mapping-file metadata/imc-2d/imc-2d-field-mappings.json \
            --value-mapping-dir shared/value-mappings \
            --target-schema-file metadata/imc-2d/imc-2d-schema.json \
            --patch-file metadata/imc-2d/imc-2d-patches.json \
            --input-dir metadata/imc-2d/input \
            --output-dir metadata/imc-2d/output

      - name: Commit transformed files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metadata/imc-2d/output
          git commit -m "Transform IMC-2D legacy metadata (automated)" || echo "No changes to commit"
          git push

      - name: Find non-standard values
        run: |
          python scripts/find-nonstandard-values.py \
            metadata/imc-2d/output \
            metadata/imc-2d/imc-2d-schema.json \
            metadata/imc-2d/imc-2d-nonstandard-values.json

      - name: Commit non-standard values
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metadata/imc-2d/imc-2d-nonstandard-values.json
          git commit -m "Find non-standard values in IMC-2D metadata (automated)" || echo "No changes to commit"
          git push

      - name: Commit Excel reports for curator review
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metadata/imc-2d/todo/
          git commit -m "Generate Excel reports grouped by institution for IMC-2D (automated)" || echo "No changes to commit"
          git push

      - name: Generate transformation summary
        run: |
          python scripts/generate-transformation-summary.py \
            --field-mapping-csv metadata/imc-2d/imc-2d-field-mappings.csv \
            --output-dir metadata/imc-2d/output \
            --patch-file metadata/imc-2d/imc-2d-patches.json \
            --title "IMC-2D" \
            --output-file metadata/imc-2d/transformation-summary.html

      - name: Commit transformation summary
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metadata/imc-2d/transformation-summary.html
          git commit -m "Generate transformation summary for IMC-2D (automated)" || echo "No changes to commit"
          git push
