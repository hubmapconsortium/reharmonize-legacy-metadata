name: Transform 10X Multiome legacy CEDAR metadata

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  transform:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install PyYAML
          pip install openpyxl
          pip install -e tools/json-rules-engine
          pip install -e tools/metadata-transformer

      - name: Generate field mapping
        run: |
          python scripts/generate-field-mapping.py \
            metadata/cedar-10x-multiome/10x-multiome-field-mappings.csv \
            metadata/cedar-10x-multiome/10x-multiome-field-mappings.json

      - name: Generate target schema
        run: |
          python scripts/generate-target-schema.py \
            "https://raw.githubusercontent.com/hubmapconsortium/dataset-metadata-spreadsheet/refs/heads/main/10x-multiome/latest/10x-multiome.yml" \
            metadata/cedar-10x-multiome/10x-multiome-schema.json

      - name: Transform metadata
        run: |
          metadata-transform \
            --field-mapping-file metadata/cedar-10x-multiome/10x-multiome-field-mappings.json \
            --value-mapping-dir shared/value-mappings \
            --target-schema-file metadata/cedar-10x-multiome/10x-multiome-schema.json \
            --patch-file metadata/cedar-10x-multiome/10x-multiome-patches.json \
            --input-dir metadata/cedar-10x-multiome/input \
            --output-dir metadata/cedar-10x-multiome/output

      - name: Commit transformed files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metadata/cedar-10x-multiome/output
          git commit -m "Transform 10X Multiome legacy CEDAR metadata (automated)" || echo "No changes to commit"
          git push

      - name: Find non-standard values
        run: |
          python scripts/find-nonstandard-values.py \
            metadata/cedar-10x-multiome/output \
            metadata/cedar-10x-multiome/10x-multiome-schema.json \
            metadata/cedar-10x-multiome/10x-multiome-nonstandard-values.json

      - name: Commit non-standard values
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metadata/cedar-10x-multiome/10x-multiome-nonstandard-values.json
          git commit -m "Find non-standard values in 10X Multiome metadata (automated)" || echo "No changes to commit"
          git push

      - name: Commit Excel reports for curator review
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add metadata/cedar-10x-multiome/todo/
          git commit -m "Generate Excel reports grouped by institution for 10X Multiome (automated)" || echo "No changes to commit"
          git push
