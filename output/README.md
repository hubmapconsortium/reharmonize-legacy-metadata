# Metadata Transformation Output Structure

This document describes the structure of metadata transformation output files generated by the metadata transformer.

## Overview

The metadata transformer processes legacy metadata and outputs a structured JSON object containing the original metadata, transformed metadata, and detailed processing logs. The system performs field mapping, value transformation, schema compliance validation, and conditional patching to convert legacy metadata formats into standardized target schemas.

## Output Structure

```json
{
  "uuid": "0a65e189fe935126e86a3f2f116f1800",
  "hubmap_id": "HBM332.CWXR.462",
  "status": "QA",
  "group_name": "University of California San Diego TMC",
  "dataset_type": "RNAseq",
  "metadata": {...},
  "modified_metadata": {...},
  "processing_log": {
    "field_mappings": {...},
    "value_mappings": {...},
    "ambiguous_mappings": [...],
    "excluded_data": {...},
    "metadata_patches": [...]
  }
}
```

## Field Descriptions

### Root Level Fields

| Field | Type | Description |
|-------|------|-------------|
| `uuid` | String | Unique identifier for the metadata record |
| `hubmap_id` | String | HuBMAP dataset identifier |
| `status` | String | Processing status of the dataset |
| `group_name` | String | Research group or organization name |
| `dataset_type` | String | Type of dataset (e.g., "RNAseq", "ATACseq") |
| `metadata` | Object | Original legacy metadata as provided in the input |
| `modified_metadata` | Object | Transformed metadata conforming to the target schema |
| `processing_log` | Object | Detailed log of all transformation operations performed |

### Processing Log Structure

The `processing_log` object contains detailed information about the transformation process:

#### `field_mappings`
**Type:** Object  
**Description:** Maps legacy field names to their corresponding target schema field names.

```json
"field_mappings": {
  "acquisition_instrument_model": "acquisition_instrument_model",
  "assay_type": "dataset_type",
  "cell_barcode_offset": "barcode_offset",
  "cell_barcode_read": "barcode_read",
  "cell_barcode_size": "barcode_size",
  "expected_cell_count": "expected_entity_capture_count",
  "is_targeted": "is_targeted",
  "library_final_yield_unit": "library_output_amount_unit",
  "library_final_yield_value": "library_output_amount_value",
  "library_pcr_cycles": "number_of_iterations_of_cdna_amplification",
  "protocols_io_doi": "preparation_protocol_doi",
  "rnaseq_assay_input": "amount_of_input_analyte_value",
  "sc_isolation_cell_number": "number_of_input_cells_or_nuclei",
  "sc_isolation_entity": "assay_input_entity",
  "tissue_id": "parent_sample_id"
}
```

#### `value_mappings`
**Type:** Object  
**Description:** Maps legacy field values to their transformed values, organized by field name.

```json
"value_mappings": {
  "dataset_type": {
    "SNARE2-RNAseq": "RNAseq"
  },
  "is_targeted": {
    "False": "No"
  },
  "is_technical_replicate": {
    "False": "No"
  },
  "sequencing_read_format": {
    "70/6/102": "70,6,102"
  }
}
```

#### `ambiguous_mappings`
**Type:** Array of Objects  
**Description:** Values that could not be automatically mapped and require manual review.

```json
"ambiguous_mappings": [
  {
    "field": "acquisition_instrument_model",
    "value": "NovaSeq",
    "permissible_values": [
      "NovaSeq 6000",
      "NovaSeq X",
      "NovaSeq X Plus"
    ]
  },
  {
    "field": "sequencing_reagent_kit",
    "value": "NovaSeq 6000 S4 Reagent",
    "permissible_values": [
      "Illumina; NovaSeq 6000 S4 Reagent Kit v1.5 (300 cycles); PN 20028312",
      "Illumina; NovaSeq 6000 S4 Reagent v1.5 Kit (200 Cycles); PN 20028313"
    ]
  }
]
```

**Fields:**
- `field`: The field name where the ambiguous value was found
- `value`: The unmappable value from the legacy data
- `permissible_values`: List of acceptable values for this field in the target schema

#### `excluded_data`
**Type:** Object  
**Description:** Legacy fields and their values that could not be mapped to the target schema.

```json
"excluded_data": {
  "assay_category": "sequence",
  "description": "Single-nucleus SNARE-seq2 (dual-omic RNA and accessible chromatin sequencing) on adult human lung",
  "donor_id": "CALT0013",
  "execution_datetime": "2021-07-01 11:00",
  "library_construction_protocols_io_doi": "10.17504/protocols.io.bzdrp256",
  "library_id": "HRT65",
  "operator": "Dinh Diep",
  "operator_email": "ddiep@ucsd.edu",
  "pi": "Kun Zhang",
  "pi_email": "kzhang@eng.ucsd.edu"
}
```

#### `metadata_patches`
**Type:** Array of Objects  
**Description:** Conditional patches that were applied to modify field values based on specific criteria.

```json
"metadata_patches": [
  {
    "field": "assay_input_entity",
    "value": "single nucleus",
    "conditions": {
      "must": {
        "assay_type": "SNARE2-RNAseq"
      }
    }
  },
  {
    "field": "barcode_read",
    "value": "Read 2 (R2)",
    "conditions": {
      "must": {
        "assay_type": "SNARE2-RNAseq"
      }
    }
  }
]
```

**Fields:**
- `field`: The field that was modified
- `value`: The new value that was applied
- `conditions`: The conditions that triggered this patch (with `must` containing required field-value pairs)
